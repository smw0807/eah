// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum AuctionStatus {
  SCHEDULED
  OPEN
  CLOSED
  CANCELED
}

enum Role {
  ADMIN
  USER
}

model User {
  id           Int           @id @default(autoincrement())
  name         String
  nickname     String        @unique
  email        String        @unique
  // 실제 DB 컬럼명은 "password"지만, 안에는 해시를 넣을 거라서 코드에선 passwordHash로 사용
  passwordHash String        @map("password")
  role         Role          @default(USER) @map("role")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt      @map("updated_at")

  // relations
  account      UserAccount?
  auctions     Auction[]     @relation("UserAuctions") // 내가 판매한 경매들
  bids         Bid[]         @relation("UserBids")     // 내가 입찰한 기록들

  @@map("users")
}

model UserAccount {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique @map("user_id")
  currentAmount Decimal  @default(0) @db.Decimal(12, 2) @map("current_amount")
  lockedAmount  Decimal  @default(0) @db.Decimal(12, 2) @map("locked_amount")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")

  // relations
  user          User     @relation(fields: [userId], references: [id])

  @@map("user_accounts")
}

model Category {
  id        Int        @id @default(autoincrement())
  code      String     @unique
  name      String

  parentId  Int?       @map("parent_id")
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

  // relations
  auctionsAsCategory    Auction[]  @relation("AuctionCategory")    // 이 카테고리를 사용하는 경매들
  auctionsAsSubCategory Auction[]  @relation("AuctionSubCategory") // 이 서브카테고리를 사용하는 경매들

  // 같은 부모 아래에서는 이름 유니크
  @@unique([parentId, code])

  @@index([parentId])

  @@map("categories")
}

model Auction {
  id            Int            @id @default(autoincrement())
  sellerId      Int            @map("seller_id")
  title         String
  description   String?
  status        AuctionStatus  @default(SCHEDULED)
  startPrice    Decimal        @db.Decimal(12, 2) @map("start_price")
  minBidStep    Decimal        @db.Decimal(12, 2) @default(0) @map("min_bid_step")
  currentPrice  Decimal?       @db.Decimal(12, 2) @map("current_price")
  buyoutPrice   Decimal?       @db.Decimal(12, 2) @map("buyout_price")

  categoryId    Int?           @map("category_id")
  subCategoryId Int?           @map("sub_category_id")
  imageUrl      String?        @map("image_url")
  startAt       DateTime       @map("start_at")
  endAt         DateTime       @map("end_at")
  winningBidId  Int?           @map("winning_bid_id") @unique
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt      @map("updated_at")

  // relations
  seller        User           @relation("UserAuctions", fields: [sellerId], references: [id])
  bids          Bid[]
  // winningBidId = 낙찰된 입찰(bids.id)의 아이디
  winningBid    Bid?           @relation("WinningBid", fields: [winningBidId], references: [id])

  category      Category?      @relation("AuctionCategory", fields: [categoryId], references: [id])
  subCategory   Category?      @relation("AuctionSubCategory", fields: [subCategoryId], references: [id])

  @@map("auctions")

  @@index([status, endAt])
  @@index([categoryId])
}

model Bid {
  id         Int      @id @default(autoincrement())
  auctionId  Int      @map("auction_id")
  bidderId   Int      @map("bidder_id")
  amount     Decimal  @db.Decimal(12, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  // relations
  auction    Auction  @relation(fields: [auctionId], references: [id])
  bidder     User     @relation("UserBids", fields: [bidderId], references: [id])
  // 이 입찰이 어떤 경매의 낙찰 입찰인지 (없을 수도 있음)
  winningFor Auction? @relation("WinningBid")

  @@map("bids")

  @@index([auctionId, createdAt(sort: Desc)])
  @@index([auctionId, amount(sort: Desc)])
}